// Highlight active page
$(document).ready(function () {
    $.each($('#navbar').find('li'), function() {
        $(this).toggleClass('active',
            $(this).find('a').attr('href') == window.location.pathname);
    });
});

// Video player
$(function() {
    var bitrate, checkStatus, play, playUrl, profile, resolution, startLoading, statusUrl, stopLoading, timer, tune, tuneUrl, videoPlayer;
    timer = null;
    videoPlayer = function() {
        return $("#video-player")[0];
    };
    statusUrl = function() {
        return $('#video-player').data('status-url');
    };
    tuneUrl = function() {
        return $('#video-player').data('tune-url') + "?resolution=" + resolution() + "&bitrate=" + bitrate() + "&profile=" + profile();
    };
    playUrl = function() {
        return $('#video-player').data('play-url');
    };
    bitrate = function() {
        return localStorage.bitrate || "3000k";
    };
    resolution = function() {
        return localStorage.resolution || "1280x720";
    };
    profile = function() {
        return localStorage.profile || "mobile";
    };
    startLoading = function(title, message) {
        var spinOpts;
        if (title == null) {
            title = null;
        }
        if (message == null) {
            message = null;
        }
        spinOpts = {
            className: 'spinner'
        };
        $('.alert').spin(spinOpts);
        $('.alert h4').html(title);
        $('.alert').append(message);
        return $('.alert').show();
    };
    stopLoading = function(title, message) {
        if (title == null) {
            title = null;
        }
        if (message == null) {
            message = null;
        }
        $('.alert').spin(false);
        $('.alert h4').html(title);
        $('.alert').append(message);
        if ((title == null) && (message == null)) {
            return $('.alert').hide();
        }
    };
    tune = function() {
        console.log('tuning channel');
        return $.ajax(tuneUrl(), {
            type: 'post',
            dataType: 'json',
            beforeSend: function(jqXHR) {
                jqXHR.setRequestHeader("Accept", "application/json");
                return startLoading("Tuning channel...");
            },
            success: function(data, textStatus, jqXHR) {
                if (timer != null) {
                    clearInterval(timer);
                }
                return timer = setInterval(function() {
                    console.log("Checking status after tuning")
                    return checkStatus();
                }, 1000);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error tuning channgel", textStatus, errorThrown);
            }
        });
    };
    play = function() {
        var agentID, deviceAgent;
        deviceAgent = navigator.userAgent.toLowerCase();
        agentID = deviceAgent.match(/(iphone|ipod|ipad)/);
        $(videoPlayer()).show();
        videoPlayer().src = playUrl();
        videoPlayer().play();
        if (agentID && agentID[1] === 'iphone') {
            return window.location.href = playUrl();
        }
    };
    checkStatus = function() {
        return $.ajax(statusUrl(), {
            type: 'get',
            dataType: 'json',
            beforeSend: function(jqXHR) {
                jqXHR.setRequestHeader("Accept", "application/json");
                return startLoading('Preparing stream...');
            },
            success: function(data, textStatus, jqXHR) {
                console.log(data);
                if (data.ready) {
                    clearInterval(timer);
                    stopLoading('Stream is ready!', 'The stream is ready to play.');
                    return play();
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log(textStatus);
                console.log(errorThrown);
                tune();
            }
        });
    };
    if (videoPlayer() != null) {
        return checkStatus();
    }
});

// ---
// generated by coffee-script 1.9.2